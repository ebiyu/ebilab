# ebilab v3 設計思想とアーキテクチャ

このドキュメントは、`ebilab` v2の設計思想、コアアーキテクチャ、および主要な機能についてまとめたものです。

---

## 1. コアコンセプト

`ebilab`は、研究者が実験コードの複雑な部分（GUI、スレッド、非同期処理など）を意識することなく、**実験の本質的なロジックに集中できる**環境を提供することを目的とします。

* **宣言的なAPI**: ユーザーは「何をするか」をクラスやパラメータとして宣言的に記述します。
* **疎結合アーキテクチャ**: UI、コアロジック、実験定義を明確に分離し、高いテスト容易性と拡張性を実現します。
* **安全性と再現性**: 実験のライフサイクルをフレームワークが管理することで、安全な中断処理とクリーンな実行環境を保証します。

---

## 2. 全体アーキテクチャ

アプリケーションは、責務を分離した複数のレイヤーで構成されます。UIフレームワーク（PySide6など）とコアロジックは、**アダプタ**を介して接続され、互いに独立性を保ちます。

* **View (UI層)**: UIの描画とユーザー入力の受付に専念する「ダム」なコンポーネント (`MainWindow`)。
* **Controller (UI制御層)**: Viewとコアロジックを繋ぐ薄い「接着剤」(`UIController`)。
* **Adapter (ブリッジ層)**: コアロジックからのイベントをUIフレームワークのイベント（シグナルなど）に変換する「通訳者」(`ServiceQtAdapter`)。
* **Service (コアロジック層)**: UIを一切意識しない、アプリケーションの「頭脳」(`ExperimentService`)。
* **Model (データ定義層)**: ユーザーが記述する具体的な実験手順 (`Experiment`クラス)。

---

## 3. 主要API

ユーザーが直接触れるAPIは、シンプルかつ直感的に設計されています。

### `Experiment` クラス
実験のパラメータとライフサイクルを定義します。

* **パラメータ**: `IntegerField`などの**フィールドクラス**をクラスメンバとして定義し、GUIとバリデーションを自動生成します。
* **ライフサイクル**: `async def`で統一された以下の3つのメソッドを実装します。
    * `setup()`: 実験の準備
    * `steps()`: データを`yield`するメインループ
    * `cleanup()`: 正常終了・中断・エラー時に必ず呼ばれる後処理

### `Plotter` クラス
可視化ロジックをカプセル化します。

* `@Experiment.register_plotter`デコレータで`Experiment`に関連付けられます。
* `update()`メソッドを実装し、`yield`されたデータに基づいた描画ロジックを記述します。

---

## 4. 実行モデル

### `async` First
実験は本質的にI/Oバウンドであるため、`ebilab`は**`async`を標準**とします。ユーザーは常に`async def`でライフサイクルメソッドを定義します。`await`がない単純な処理でも、`yield`の瞬間に制御がフレームワークに戻るため、UIの応答性は維持されます。

### スレッドモデル
* **実験ごとのスレッド**: 安全性とリソース分離のため、実験は**開始されるたびに新しいワーカースレッドを生成**します。
* **`ExperimentRunner`**: 一回の実験実行（`setup`から`cleanup`まで）の責務を持つクラス。`ExperimentService`がこれを生成し、スレッドで実行します。
* **イベントループ**: 各`ExperimentRunner`は、`asyncio.run()`を通じて、自身のスレッド内で独立したイベントループを構築・実行します。

---

## 5. UI設計

* **推奨フレームワーク**: PySide6 + PyQtGraph / matplotlib
* **レイアウト**: 2カラム構成
    * **左パネル**: 「実験設定」と「実験履歴」を切り替えるタブコントロール。
    * **右パネル**: 上下に分割。上がメインのプロットエリア、下が「結果テーブル」と「ログ」を切り替えるタブコントロール。

---

## 6. 主要機能

### 監視モード
`with ebilab.monitor() as monitor:`構文を使い、`yield`を使わない既存のPythonスクリプトに`monitor.update(data)`を挿入するだけで、その進捗をリアルタイムに可視化します。

### ロギング
* **グローバルログ**: `ebilab`本体のデバッグ用に、アプリケーション全体で一つのログファイルを出力します。
* **実験ログ**: 実験データ（CSV）の隣に、`INFO`レベル以上（見返し用）と`DEBUG`レベル以上（実験デバッグ用）の2種類のログファイルを自動で生成します。

### ホットリロード
実験待機中に実験定義ファイルを変更すると、自動でリロードされ、UIが動的に再構築されます。

---

## 7. 開発・配布方針

* **パッケージ名**: `ebilab` (変更しない)
* **インポート名**: `ebilab` (変更しない)
* **Gitリポジトリ**: 既存のリポジトリを維持し、`v3`ブランチで開発を進める。
* **バージョン管理**: セマンティックバージョニングに従い、`v3.0.0`としてリリースする。